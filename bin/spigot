#!/usr/bin/env node

var nopt = require("nopt");
var path = require("path");
var _ = require('underscore');

var knownOpts = {
    "parallel": Boolean,
    "username": String,
    "password": String,
    "url": String,
    "throttle": Number,
    "throttleinterval": Number,
    "forever": Boolean
};

var shortHands = {
    "u": ["--username"],
    "p": ["--password"]
}

var parsed = nopt(knownOpts, shortHands, process.argv, 2)

var Spigot = new require("../index.js");

if (parsed.argv.remain.length == 0) {
    console.log("Requires a data file");
    return;
}

var data = _.flatten(_.map(parsed.argv.remain, function(f) {
    return require(path.resolve(process.cwd(), f));
}));

var spigot = new Spigot({
    url: parsed.url || 'http://localhost/VersionOne.Web',
    username: parsed.username,
    password: parsed.password,
    throttle: parsed.throttle,
    throttleInterval: parsed.throttleinterval,
    forever: parsed.forever
});

if (parsed.parallel) {
    console.log('Executing in a parallel');
    spigot.executeParallel(data);
}
else {
    console.log('Executing in sequence');
    spigot.executeSeries(data);
}