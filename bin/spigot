#!/usr/bin/env node

var nopt = require("nopt");
var path = require("path");
var _ = require('underscore');

var knownOpts = {
    "parallel": Boolean,
    "username": String,
    "password": String,
    "url": String,
    "thottle": Number,
    "forever": Boolean
};

var shortHands = {
    "u": ["--username"],
    "p": ["--password"]
}

var parsed = nopt(knownOpts, shortHands, process.argv, 2)

var CommandProcessor = new require("../lib/command-processor.js");

if (parsed.argv.remain.length == 0) {
    console.log("Requires a data file");
    return;
}

var data = _.flatten(_.map(parsed.argv.remain, function(f){
    return require(process.cwd() + "/" + f);
}));

var commandProcessor = new CommandProcessor({
    url: parsed.url,
    username: parsed.username,
    password: parsed.password,
    throttle: parsed.throttle,
    forever: parsed.forever
});

if (parsed.parallel) {
    console.log('Executing in a parallel');
    commandProcessor.executeParallel(data);
}
else {
    console.log('Executing in sequence');
    commandProcessor.executeSeries(data);
}